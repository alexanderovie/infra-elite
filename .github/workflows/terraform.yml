name: Terraform Plan/Apply

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  push:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  schedule:
    - cron: '23 3 * * *'  # Drift check diario 03:23 UTC

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

env:
  TF_VERSION: '1.5.0'
  GOOGLE_PROJECT_ID: ${{ secrets.GOOGLE_PROJECT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
  TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
  TF_STATE_PREFIX: ${{ vars.TF_STATE_PREFIX }}
  TF_STATE_REGION: 'us'

jobs:
  plan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/304053580743/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: terraform@${{ env.GOOGLE_PROJECT_ID }}.iam.gserviceaccount.com
          create_credentials_file: true
          export_environment_variables: true

      - name: Bootstrap tfstate bucket (idempotent)
        run: |
          sudo apt-get update && sudo apt-get install -y google-cloud-cli
          ./scripts/bootstrap_state.sh

      - name: Terraform Init (remote backend)
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="prefix=${TF_STATE_PREFIX}" \
            -backend-config="project=${GOOGLE_PROJECT_ID}"

      - name: Importar recurso DNS existente (si aplica)
        id: import_dns
        working-directory: terraform
        continue-on-error: true
        run: |
          # Verificar si el m√≥dulo dns_mensajeria est√° en el c√≥digo
          if grep -q 'module "dns_mensajeria"' main.tf; then
            echo "üîç M√≥dulo dns_mensajeria encontrado en c√≥digo"
            # Verificar si ya est√° en el estado
            if terraform state list 2>/dev/null | grep -q "module.dns_mensajeria"; then
              echo "‚úÖ Recurso ya est√° en el estado"
            else
              echo "üì• Importando recurso DNS desde Cloudflare..."
              # Obtener Record ID desde Cloudflare API
              ZONE_ID="${{ secrets.CLOUDFLARE_ZONE_ID }}"
              CF_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
              RECORD_NAME="mensajeria.fascinantedigital.com"

              RESPONSE=$(curl -s -X GET \
                "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records?name=${RECORD_NAME}&type=CNAME" \
                -H "Authorization: Bearer ${CF_TOKEN}" \
                -H "Content-Type: application/json")

              RECORD_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

              if [ -n "$RECORD_ID" ]; then
                echo "‚úÖ Record ID encontrado: ${RECORD_ID}"
                terraform import module.dns_mensajeria.cloudflare_record.this "${ZONE_ID}/${RECORD_ID}" || echo "‚ö†Ô∏è Import fall√≥ (puede que ya est√© en el estado o no exista)"
              else
                echo "‚ö†Ô∏è No se encontr√≥ el registro en Cloudflare"
              fi
            fi
          else
            echo "‚ÑπÔ∏è M√≥dulo dns_mensajeria no est√° en el c√≥digo, saltando import"
          fi

      - name: Terraform Fmt & Validate
        working-directory: terraform
        run: |
          terraform fmt -recursive -diff || true
          terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: terraform
        env:
          TF_VAR_google_project_id: ${{ env.GOOGLE_PROJECT_ID }}
          TF_VAR_cloudflare_account_id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ env.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ env.CLOUDFLARE_API_TOKEN }}
        run: |
          terraform plan -no-color -out=tfplan \
            -var="google_project_id=${GOOGLE_PROJECT_ID}" \
            -var="cloudflare_account_id=${CLOUDFLARE_ACCOUNT_ID}" \
            -var="cloudflare_zone_id=${CLOUDFLARE_ZONE_ID}" \
            -var="cloudflare_api_token=${CLOUDFLARE_API_TOKEN}" \
            | tee plan.txt
          echo "PLAN<<EOF" >> $GITHUB_ENV
          cat plan.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Comment plan on PR
        uses: actions/github-script@v7
        env:
          PLAN: ${{ env.PLAN }}
        with:
          script: |
            const body = `#### Terraform Plan üìñ
            \`\`\`
            ${process.env.PLAN || 'No hay cambios'}
            \`\`\`
            _Pusheado por: @${context.actor}_`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  apply:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: []
    runs-on: ubuntu-24.04
    concurrency:
      group: tf-apply-main
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/304053580743/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: terraform@${{ env.GOOGLE_PROJECT_ID }}.iam.gserviceaccount.com
          create_credentials_file: true
          export_environment_variables: true

      - name: Bootstrap tfstate bucket (idempotent)
        run: |
          sudo apt-get update && sudo apt-get install -y google-cloud-cli
          ./scripts/bootstrap_state.sh

      - name: Terraform Init (remote backend)
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="prefix=${TF_STATE_PREFIX}" \
            -backend-config="project=${GOOGLE_PROJECT_ID}"

      - name: Importar recurso DNS existente (si aplica)
        id: import_dns
        working-directory: terraform
        continue-on-error: true
        run: |
          # Verificar si el m√≥dulo dns_mensajeria est√° en el c√≥digo
          if grep -q 'module "dns_mensajeria"' main.tf; then
            echo "üîç M√≥dulo dns_mensajeria encontrado en c√≥digo"
            # Verificar si ya est√° en el estado
            if terraform state list 2>/dev/null | grep -q "module.dns_mensajeria"; then
              echo "‚úÖ Recurso ya est√° en el estado"
            else
              echo "üì• Importando recurso DNS desde Cloudflare..."
              # Obtener Record ID desde Cloudflare API
              ZONE_ID="${{ secrets.CLOUDFLARE_ZONE_ID }}"
              CF_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
              RECORD_NAME="mensajeria.fascinantedigital.com"

              RESPONSE=$(curl -s -X GET \
                "https://api.cloudflare.com/client/v4/zones/${ZONE_ID}/dns_records?name=${RECORD_NAME}&type=CNAME" \
                -H "Authorization: Bearer ${CF_TOKEN}" \
                -H "Content-Type: application/json")

              RECORD_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

              if [ -n "$RECORD_ID" ]; then
                echo "‚úÖ Record ID encontrado: ${RECORD_ID}"
                terraform import module.dns_mensajeria.cloudflare_record.this "${ZONE_ID}/${RECORD_ID}" || echo "‚ö†Ô∏è Import fall√≥ (puede que ya est√© en el estado o no exista)"
              else
                echo "‚ö†Ô∏è No se encontr√≥ el registro en Cloudflare"
              fi
            fi
          else
            echo "‚ÑπÔ∏è M√≥dulo dns_mensajeria no est√° en el c√≥digo, saltando import"
          fi

      - name: Terraform Plan (for artifact)
        id: plan
        working-directory: terraform
        env:
          TF_VAR_google_project_id: ${{ env.GOOGLE_PROJECT_ID }}
          TF_VAR_cloudflare_account_id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ env.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ env.CLOUDFLARE_API_TOKEN }}
        run: |
          terraform plan -no-color -out=tfplan \
            -var="google_project_id=${GOOGLE_PROJECT_ID}" \
            -var="cloudflare_account_id=${CLOUDFLARE_ACCOUNT_ID}" \
            -var="cloudflare_zone_id=${CLOUDFLARE_ZONE_ID}" \
            -var="cloudflare_api_token=${CLOUDFLARE_API_TOKEN}"

      - name: Terraform Apply (non-interactive)
        working-directory: terraform
        run: terraform apply -auto-approve tfplan

  drift:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/304053580743/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: terraform@${{ env.GOOGLE_PROJECT_ID }}.iam.gserviceaccount.com
          create_credentials_file: true
          export_environment_variables: true

      - name: Bootstrap tfstate bucket (idempotent)
        run: |
          sudo apt-get update && sudo apt-get install -y google-cloud-cli
          ./scripts/bootstrap_state.sh

      - name: Terraform Init (backend)
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="prefix=${TF_STATE_PREFIX}" \
            -backend-config="project=${GOOGLE_PROJECT_ID}"

      - name: Terraform Plan (detect drift)
        id: plan
        working-directory: terraform
        continue-on-error: true
        env:
          TF_VAR_google_project_id: ${{ env.GOOGLE_PROJECT_ID }}
          TF_VAR_cloudflare_account_id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ env.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ env.CLOUDFLARE_API_TOKEN }}
        run: |
          set +e
          terraform plan -no-color -detailed-exitcode \
            -var="google_project_id=${GOOGLE_PROJECT_ID}" \
            -var="cloudflare_account_id=${CLOUDFLARE_ACCOUNT_ID}" \
            -var="cloudflare_zone_id=${CLOUDFLARE_ZONE_ID}" \
            -var="cloudflare_api_token=${CLOUDFLARE_API_TOKEN}" \
            | tee plan.txt
          echo "EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_ENV
          echo "PLAN<<EOF" >> $GITHUB_ENV
          cat plan.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Open issue if drift
        if: env.EXIT_CODE == '2'
        uses: actions/github-script@v7
        env:
          PLAN: ${{ env.PLAN }}
        with:
          script: |
            const title = "üö® Terraform drift detectado";
            const body = `Se detectaron cambios pendientes en la infraestructura:\n\n\`\`\`\n${process.env.PLAN || ""}\n\`\`\`\n\nRevisa el estado y aplica los cambios necesarios.`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body
            });
