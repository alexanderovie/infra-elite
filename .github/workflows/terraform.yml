name: Terraform Plan/Apply

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  push:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  schedule:
    - cron: '23 3 * * *'  # Drift check diario 03:23 UTC

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

env:
  TF_VERSION: '1.5.0'
  GOOGLE_PROJECT_ID: ${{ secrets.GOOGLE_PROJECT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
  TF_STATE_BUCKET: ${{ vars.TF_STATE_BUCKET }}
  TF_STATE_PREFIX: ${{ vars.TF_STATE_PREFIX }}
  TF_STATE_REGION: 'us'

jobs:
  plan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    concurrency:
      group: tf-plan-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/304053580743/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: terraform@${{ env.GOOGLE_PROJECT_ID }}.iam.gserviceaccount.com
          create_credentials_file: true
          export_environment_variables: true

      - name: Bootstrap tfstate bucket (idempotent)
        run: |
          sudo apt-get update && sudo apt-get install -y google-cloud-cli
          export GOOGLE_CLOUD_PROJECT="${GOOGLE_PROJECT_ID}"
          export GCLOUD_PROJECT="${GOOGLE_PROJECT_ID}"
          ./scripts/bootstrap_state.sh

      - name: Terraform Init (remote backend)
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="prefix=${TF_STATE_PREFIX}"

      - name: Liberar locks orphaned (si existen)
        working-directory: terraform
        continue-on-error: true
        env:
          TF_VAR_google_project_id: ${{ env.GOOGLE_PROJECT_ID }}
          TF_VAR_cloudflare_account_id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ env.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ env.CLOUDFLARE_API_TOKEN }}
        run: |
          ../scripts/unlock_state.sh .

      - name: Importar recurso DNS existente (si aplica)
        id: import_dns
        working-directory: terraform
        continue-on-error: true
        env:
          TF_VAR_google_project_id: ${{ env.GOOGLE_PROJECT_ID }}
          TF_VAR_cloudflare_account_id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ env.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ env.CLOUDFLARE_ZONE_ID }}
        run: |
          ../scripts/safe_import_dns.sh || echo "‚ö†Ô∏è Import fall√≥, continuando..."

      - name: Terraform Fmt & Validate
        working-directory: terraform
        run: |
          terraform fmt -recursive -diff || true
          terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: terraform
        env:
          TF_VAR_google_project_id: ${{ env.GOOGLE_PROJECT_ID }}
          TF_VAR_cloudflare_account_id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ env.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ env.CLOUDFLARE_API_TOKEN }}
        run: |
          terraform plan -no-color -out=tfplan \
            -var="google_project_id=${GOOGLE_PROJECT_ID}" \
            -var="cloudflare_account_id=${CLOUDFLARE_ACCOUNT_ID}" \
            -var="cloudflare_zone_id=${CLOUDFLARE_ZONE_ID}" \
            -var="cloudflare_api_token=${CLOUDFLARE_API_TOKEN}" \
            | tee plan.txt
          echo "PLAN<<EOF" >> $GITHUB_ENV
          cat plan.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Comment plan on PR
        uses: actions/github-script@v7
        env:
          PLAN: ${{ env.PLAN }}
        with:
          script: |
            const body = `#### Terraform Plan üìñ
            \`\`\`
            ${process.env.PLAN || 'No hay cambios'}
            \`\`\`
            _Pusheado por: @${context.actor}_`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  apply:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: []
    runs-on: ubuntu-24.04
    concurrency:
      group: tf-apply-main
      cancel-in-progress: false
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/304053580743/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: terraform@${{ env.GOOGLE_PROJECT_ID }}.iam.gserviceaccount.com
          create_credentials_file: true
          export_environment_variables: true

      - name: Bootstrap tfstate bucket (idempotent)
        run: |
          sudo apt-get update && sudo apt-get install -y google-cloud-cli
          export GOOGLE_CLOUD_PROJECT="${GOOGLE_PROJECT_ID}"
          export GCLOUD_PROJECT="${GOOGLE_PROJECT_ID}"
          ./scripts/bootstrap_state.sh

      - name: Terraform Init (remote backend)
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="prefix=${TF_STATE_PREFIX}"

      - name: Liberar locks orphaned (si existen)
        working-directory: terraform
        continue-on-error: true
        env:
          TF_VAR_google_project_id: ${{ env.GOOGLE_PROJECT_ID }}
          TF_VAR_cloudflare_account_id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ env.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ env.CLOUDFLARE_API_TOKEN }}
        run: |
          ../scripts/unlock_state.sh .

      - name: Importar recurso DNS existente (si aplica)
        id: import_dns
        working-directory: terraform
        continue-on-error: true
        env:
          TF_VAR_google_project_id: ${{ env.GOOGLE_PROJECT_ID }}
          TF_VAR_cloudflare_account_id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ env.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ env.CLOUDFLARE_ZONE_ID }}
        run: |
          ../scripts/safe_import_dns.sh || echo "‚ö†Ô∏è Import fall√≥, continuando..."

      - name: Terraform Plan
        id: plan
        working-directory: terraform
        env:
          TF_VAR_google_project_id: ${{ env.GOOGLE_PROJECT_ID }}
          TF_VAR_cloudflare_account_id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ env.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ env.CLOUDFLARE_API_TOKEN }}
        run: |
          terraform plan -no-color -out=tfplan \
            -var="google_project_id=${GOOGLE_PROJECT_ID}" \
            -var="cloudflare_account_id=${CLOUDFLARE_ACCOUNT_ID}" \
            -var="cloudflare_zone_id=${CLOUDFLARE_ZONE_ID}" \
            -var="cloudflare_api_token=${CLOUDFLARE_API_TOKEN}"

      - name: Terraform Apply (non-interactive)
        working-directory: terraform
        run: terraform apply -auto-approve tfplan

  drift:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-24.04
    concurrency:
      group: tf-drift
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/304053580743/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: terraform@${{ env.GOOGLE_PROJECT_ID }}.iam.gserviceaccount.com
          create_credentials_file: true
          export_environment_variables: true

      - name: Bootstrap tfstate bucket (idempotent)
        run: |
          sudo apt-get update && sudo apt-get install -y google-cloud-cli
          export GOOGLE_CLOUD_PROJECT="${GOOGLE_PROJECT_ID}"
          export GCLOUD_PROJECT="${GOOGLE_PROJECT_ID}"
          ./scripts/bootstrap_state.sh

      - name: Terraform Init (backend)
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="prefix=${TF_STATE_PREFIX}"

      - name: Liberar locks orphaned (si existen)
        working-directory: terraform
        continue-on-error: true
        env:
          TF_VAR_google_project_id: ${{ env.GOOGLE_PROJECT_ID }}
          TF_VAR_cloudflare_account_id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ env.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ env.CLOUDFLARE_API_TOKEN }}
        run: |
          ../scripts/unlock_state.sh .

      - name: Terraform Plan (detect drift)
        id: plan
        working-directory: terraform
        continue-on-error: true
        env:
          TF_VAR_google_project_id: ${{ env.GOOGLE_PROJECT_ID }}
          TF_VAR_cloudflare_account_id: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ env.CLOUDFLARE_ZONE_ID }}
          TF_VAR_cloudflare_api_token: ${{ env.CLOUDFLARE_API_TOKEN }}
        run: |
          set +e
          terraform plan -no-color -detailed-exitcode \
            -var="google_project_id=${GOOGLE_PROJECT_ID}" \
            -var="cloudflare_account_id=${CLOUDFLARE_ACCOUNT_ID}" \
            -var="cloudflare_zone_id=${CLOUDFLARE_ZONE_ID}" \
            -var="cloudflare_api_token=${CLOUDFLARE_API_TOKEN}" \
            | tee plan.txt
          echo "EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_ENV
          echo "PLAN<<EOF" >> $GITHUB_ENV
          cat plan.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Open issue if drift
        if: env.EXIT_CODE == '2'
        uses: actions/github-script@v7
        env:
          PLAN: ${{ env.PLAN }}
        with:
          script: |
            const title = "üö® Terraform drift detectado";
            const body = `Se detectaron cambios pendientes en la infraestructura:\n\n\`\`\`\n${process.env.PLAN || ""}\n\`\`\`\n\nRevisa el estado y aplica los cambios necesarios.`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body
            });
